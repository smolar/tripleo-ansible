---
# Copyright 2020 Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


# "tripleo_provision_mcelog" will search for and load any operating system variable file

# found within the "vars/" path. If no OS files are found the task will skip.
- name: Gather variables for each operating system
  include_vars: "{{ item }}"
  with_first_found:
    - skip: true
      files:
        - "{{ ansible_distribution | lower }}-{{ ansible_distribution_version | lower }}.yml"
        - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version | lower }}.yml"
        - "{{ ansible_os_family | lower }}-{{ ansible_distribution_major_version | lower }}.yml"
        - "{{ ansible_distribution | lower }}.yml"
        - "{{ ansible_os_family | lower }}-{{ ansible_distribution_version.split('.')[0] }}.yml"
        - "{{ ansible_os_family | lower }}.yml"
  tags:
    - always

# mcelog
- name: Ensure mcelog is installed
  yum:
    name: mcelog
    state: installed
  when: "ansible_facts['os_family'] == 'RedHat'"

- name: Ensure mcelog is enabled and started
  systemd:
    state: started
    name: rsyslog
    enabled: true
    daemon-reload: yes

# snmpd
- name: Downloading net-snmp sources
  get_url:
    url: "{{ net_snmp_url }}"
    dest: "/usr/local/src/net-snmp-{{ net_snmp_version }}.tar.gz"
  register: net_snmp_source

- name: Unpacking net-snmp
  unarchive:
    copy: no
    dest: "/usr/local/src/"
    src: "{{ net_snmp_source.dest }}"
  when: net_snmp_source.changed

- name: Configuring net-snmp source
  shell: ./configure --with-default-snmp-version="3" --with-sys-contact="some@email.com" --with-sys-location="None" --with-logfile="/var/log/snmpd.log" --with-persistent-directory="/var/net-snmp" --enable-shared --prefix=/usr
  args:
    chdir: "/usr/local/src/net-snmp-{{ net_snmp_version }}"
  register: net_snmp_configure

- name: Installing net-snmp
  become: yes
  shell: make sedscript && make -j && make install
  args:
    chdir: "/usr/local/src/net-snmp-{{ net_snmp_version }}"
  when: net_snmp_configure is changed
  register: net_snmp_installed

- name: Copy snmpd config
  copy:
    src: "/usr/local/src/net-snmp-{{ net_snmp_version }}/EXAMPLE.conf.def"
    dest: /usr/share/snmp/snmpd.conf
    remote_src: yes

- name: Change snmpd config
  lineinfile:
    path: /usr/share/snmp/snmpd.conf
    line: "viewsystemonly  included   .1"
    insertafter: EOF
    state: present

- name: Add systemd unit template
  template:
    src: snmpd.service
    dest: /lib/systemd/system/snmpd.service
    mode: 0755
    owner: root
    group: root

- name: Set library path and
  lineinfile:
    path: ~/.bashrc
    line: "export LD_LIBRARY_PATH=/usr/lib"
    insertafter: EOF
    state: present

- name: Set default MIB configuration
  shell: net-snmp-config --default-mibdirs && net-snmp-config --snmpconfpath
  environment:
    LD_LIBRARY_PATH: "/usr/lib"

- name: Ensure snmpd is enabled and started
  systemd:
    state: started
    name: snmpd
    enabled: true
    daemon-reload: yes
  when: net_snmp_installed.changed